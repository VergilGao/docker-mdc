name: test

on: 
  push:
    branches:
      - master
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".github/**"
      - "build-stage/**"
  pull_request:
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".github/**"
      - "build-stage/**"
  workflow_dispatch:
    inputs:
      start_test:
        description: '构建测试镜像'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    
    - name: Create Test User and test files
      run: |
        sudo groupadd -g 1024 mdc
        sudo useradd -u 1024 mdc -g mdc
        mkdir data data/amd64 data/arm64
        dd if=/dev/zero of="./data/amd64/MIFD-046.mp4" bs=250MB count=1
        dd if=/dev/zero of="./data/arm64/SVDVD-471.mp4" bs=250MB count=1
        sudo chown -R 99:100 test
        ls -al test
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build the test image
      run: |
        docker buildx create \
          --name testbuilder \
          --driver docker-container \
          --bootstrap \
          --use
        docker buildx build \
          --platform=linux/amd64,linux/arm64 \
          --build-arg BUILD_DATE=$(date +"%Y-%m-%d") \
          -t vergilgao/mdc:test \
          . 

    - name: Run amd64 test
      if: success()
      run: |
        docker run \
          --rm \
          --platform linux/amd64
          --name=mdc_test \
          -e UID=1024 \
          -e GID=1024 \
          -v ${PWD}/config/amd64:/config \
          -v ${PWD}/data/amd64:/data \
          vergilgao/mdc:test || true
        docker run \
          --rm \
          --platform linux/amd64
          --name=mdc_test \
          -e UID=1024 \
          -e GID=1024 \
          -v ${PWD}/config/amd64:/config \
          -v ${PWD}/data/amd64:/data \
          vergilgao/mdc:test
        ls -al data/amd64/*/

    - name: Run arm64 test
      if: success()
      run: |
        docker run \
          --rm \
          --platform linux/arm64
          --name=mdc_test \
          -e UID=1024 \
          -e GID=1024 \
          -v ${PWD}/config/arm64:/config \
          -v ${PWD}/data/arm64:/data \
          vergilgao/mdc:test || true
        docker run \
          --rm \
          --platform linux/arm64
          --name=mdc_test \
          -e UID=1024 \
          -e GID=1024 \
          -v ${PWD}/config/arm64:/config \
          -v ${PWD}/data/arm64:/data \
          vergilgao/mdc:test
        ls -al data/arm64/*/